<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSpaSync Pro - Live Demo (Production)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #e5e7eb !important;
            color: #9ca3af !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .upload-zone.drag-active {
            border-color: #667eea;
            background: #dbeafe;
            transform: scale(1.02);
        }

        .loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        .revenue-highlight {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        .tier-locked {
            filter: grayscale(100%);
            opacity: 0.6;
        }

        .pro-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <span class="ml-3 text-xl font-bold text-gray-900">MedSpaSync Pro</span>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <span class="text-sm text-green-600 font-semibold">‚ú® Production Demo</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Hero Demo Section -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 ml-3">Revenue Recovery Demo</h1>
            </div>
            <p class="text-xl text-gray-600 mb-4">See exactly how much revenue you're losing to unmatched rewards</p>
            <div class="revenue-highlight inline-block mb-6">
                üéØ This demo will show you real money being lost every month
            </div>
        </div>

        <!-- Plan Selection -->
        <div class="card p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Select Your Plan</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors" 
                     onclick="selectTier('core')" id="coreCard">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold">Core Reconciliation</h3>
                        <input type="radio" name="tier" value="core" checked class="text-blue-600">
                    </div>
                    <div class="text-2xl font-bold text-blue-600 mb-2">$299/month</div>
                    <p class="text-gray-600 text-sm">Perfect for single-location spas</p>
                </div>
                
                <div class="border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-purple-500 transition-colors relative" 
                     onclick="selectTier('professional')" id="professionalCard">
                    <div class="pro-badge absolute -top-2 -right-2">COMING SOON</div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold">Professional Suite</h3>
                        <input type="radio" name="tier" value="professional" class="text-purple-600">
                    </div>
                    <div class="text-2xl font-bold text-purple-600 mb-2">$499/month</div>
                    <p class="text-gray-600 text-sm">For growing spa businesses</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="startCheckout()" class="btn btn-success text-lg px-8 py-4" id="checkoutBtn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Subscribe Now - $299/month
                </button>
                <p class="text-sm text-gray-500 mt-2">30-day money-back guarantee ‚Ä¢ Cancel anytime</p>
            </div>
        </div>

        <!-- Demo Tool -->
        <div class="card p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Try With Real Data</h2>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <button onclick="loadSampleData('pos')" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Load POS Data (8 transactions)
                </button>
                <button onclick="loadSampleData('alle')" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Load Alle Rewards (6 transactions)
                </button>
                <button onclick="loadSampleData('aspire')" class="btn btn-primary" id="aspireBtn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span id="aspireText">Load Aspire Data (2 transactions)</span>
                </button>
            </div>

            <!-- Pro Feature Notice -->
            <div id="proNotice" class="bg-purple-50 border border-purple-200 p-4 rounded-lg mb-6 hidden">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                    <span class="text-purple-800 font-semibold">Aspire integration requires Professional Suite ($499/month)</span>
                </div>
            </div>

            <div class="upload-zone mb-6" id="uploadZone">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Or Upload Your Own CSV Files</h3>
                <p class="text-gray-600 mb-4">Test with your actual POS, Alle, and Aspire data</p>
                <p class="text-sm text-gray-500">Your data is processed securely and never stored</p>
                <input type="file" id="fileInput" accept=".csv" multiple class="hidden">
            </div>

            <!-- File List -->
            <div id="fileList" class="mb-6"></div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-blue-700 font-medium">ü§ñ AI Processing and matching...</span>
                    <span id="progressText" class="text-sm text-blue-700 font-bold">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Reconcile Button -->
            <button id="reconcileBtn" class="btn btn-success w-full text-lg" onclick="startReconciliation()" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Start AI Reconciliation
            </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden fade-in">
            <!-- Revenue Impact Alert -->
            <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6 rounded-xl mb-8 text-center">
                <h3 class="text-2xl font-bold mb-2">üéâ Revenue Recovery Found!</h3>
                <div class="text-4xl font-bold mb-2" id="recoveredAmount">$0</div>
                <p class="text-lg">in previously unmatched rewards that would have been lost forever</p>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 bg-green-50 border-green-200">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Automatic Matches</p>
                            <p id="totalMatches" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6 bg-blue-50 border-blue-200">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Match Accuracy</p>
                            <p id="matchRate" class="text-3xl font-bold text-blue-600">0%</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6 bg-yellow-50 border-yellow-200">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Need Review</p>
                            <p id="unmatchedCount" class="text-3xl font-bold text-yellow-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6 bg-purple-50 border-purple-200">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Processing Time</p>
                            <p id="processingTime" class="text-3xl font-bold text-purple-600">2.1s</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results -->
            <div class="card p-8 mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                    <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Detailed Match Results
                </h3>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left p-3">Client Name</th>
                                <th class="text-left p-3">POS Amount</th>
                                <th class="text-left p-3">Rewards Amount</th>
                                <th class="text-left p-3">Date</th>
                                <th class="text-left p-3">Confidence</th>
                                <th class="text-left p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="matchResults">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Export Section -->
            <div class="card p-8 mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Export Results</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="exportBtn" class="btn btn-primary" onclick="exportReport()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span id="exportText">Download CSV Report</span>
                    </button>
                    <div id="exportNotice" class="text-purple-600 text-sm hidden">
                        üìä Advanced export features available in Professional Suite
                    </div>
                </div>
            </div>

            <!-- Final CTA -->
            <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-8 rounded-xl text-center">
                <h3 class="text-2xl font-bold mb-4">Ready to Stop Losing Revenue?</h3>
                <p class="text-lg mb-6">This demo just found money you're losing every month. Imagine what we'd find in your full transaction history.</p>
                <button onclick="startCheckout()" class="btn bg-white text-green-600 hover:bg-gray-100 text-lg px-8 py-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Start Saving Now - <span id="finalPrice">$299/month</span>
                </button>
                <p class="text-sm mt-4 text-green-100">30-day money-back guarantee ‚Ä¢ Cancel anytime ‚Ä¢ Start immediately</p>
            </div>
        </div>
    </div>

    <script>
        // Stripe Price IDs (from your production setup)
        const PRICES = {
            core: 'price_1RXX7SFT2t8OlDeTE7ktphka',
            professional: 'price_1RXXM9FT2t8OlDeT3ntv0wp0'
        };

        let currentTier = 'professional';
        let loadedFiles = {};
        let reconciliationResults = null;

        // Sample data with realistic amounts
        let sampleData = {
            pos: [
                {name: "Sarah Johnson", amount: 385.00, date: "2024-06-01", service: "Botox + Filler Package", email: "sarah.johnson@email.com"},
                {name: "Michael Chen", amount: 280.50, date: "2024-06-01", service: "Laser Hair Removal", email: "m.chen@email.com"},
                {name: "Jennifer Smith", amount: 450.00, date: "2024-06-02", service: "CoolSculpting Session", email: "jen.smith@email.com"},
                {name: "Robert Williams", amount: 225.00, date: "2024-06-02", service: "Chemical Peel + Facial", email: "r.williams@email.com"},
                {name: "Lisa Anderson", amount: 375.75, date: "2024-06-03", service: "Dermal Fillers", email: "lisa.anderson@email.com"},
                {name: "David Martinez", amount: 195.00, date: "2024-06-03", service: "Microneedling", email: "d.martinez@email.com"},
                {name: "Jessica Taylor", amount: 165.25, date: "2024-06-04", service: "HydraFacial", email: "jessica.taylor@email.com"},
                {name: "Christopher Brown", amount: 320.00, date: "2024-06-04", service: "Laser Resurfacing", email: "c.brown@email.com"}
            ],
            alle: [
                {name: "Sarah Johnston", amount: 38.50, date: "2024-06-01", program: "Alle Points", email: "sarah.johnson@email.com"},
                {name: "Michael Chen", amount: 28.05, date: "2024-06-01", program: "Alle Points", email: "m.chen@email.com"},
                {name: "Jennifer Smith", amount: 45.00, date: "2024-06-02", program: "Alle Points", email: "jen.smith@email.com"},
                {name: "Robert Williams", amount: 22.50, date: "2024-06-02", program: "Alle Points", email: "r.williams@email.com"},
                {name: "Lisa Anderson", amount: 37.58, date: "2024-06-03", program: "Alle Points", email: "lisa.anderson@email.com"},
                {name: "Jessica Taylor", amount: 16.53, date: "2024-06-04", program: "Alle Points", email: "jessica.taylor@email.com"}
            ],
            aspire: [
                {name: "David Martinez", amount: 50.00, date: "2024-06-03", program: "Aspire Rewards", email: "d.martinez@email.com"},
                {name: "Christopher Brown", amount: 64.00, date: "2024-06-04", program: "Aspire Rewards", email: "c.brown@email.com"}
            ]
        };

        function selectTier(tier) {
            currentTier = tier;
            const isPro = true;
            
            // Update UI
            document.querySelectorAll('input[name="tier"]').forEach(input => {
                input.checked = input.value === tier;
            });
            
            // Update card styling
            document.getElementById('coreCard').classList.toggle('border-blue-500', tier === 'core');
            document.getElementById('professionalCard').classList.toggle('border-purple-500', tier === 'professional');
            
            // Update checkout button
            const price = tier === 'professional' ? '$499' : '$299';
            document.getElementById('checkoutBtn').innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Subscribe Now - ${price}/month
            `;
            document.getElementById('finalPrice').textContent = price + '/month';
            
            // Handle feature gating
            updateFeatureAccess(isPro);
        }

        function updateFeatureAccess(isPro) {
            const aspireBtn = document.getElementById('aspireBtn');
            const exportBtn = document.getElementById('exportBtn');
            const proNotice = document.getElementById('proNotice');
            const exportNotice = document.getElementById('exportNotice');
            
            if (isPro) {
                // Professional features enabled
                aspireBtn.disabled = false;
                aspireBtn.classList.remove('tier-locked');
                exportBtn.disabled = false;
                exportBtn.classList.remove('tier-locked');
                proNotice.classList.add('hidden');
                exportNotice.classList.add('hidden');
                document.getElementById('aspireText').textContent = 'Load Aspire Data (2 transactions)';
                document.getElementById('exportText').textContent = 'Download Professional Report';
            } else {
                // Core features only
                aspireBtn.disabled = false;
                aspireBtn.classList.add('tier-locked');
                exportBtn.disabled = false;
                exportBtn.classList.remove('tier-locked');
                proNotice.classList.add('hidden'); // Hide initially
                exportNotice.classList.add('hidden');
                document.getElementById('aspireText').textContent = 'Aspire Data (Pro Only)';
                document.getElementById('exportText').textContent = 'Download Basic Report';
            }
        }

        function loadSampleData(type) {
            if (false) {
                document.getElementById('proNotice').classList.remove('hidden');
                setTimeout(() => {
                    if (confirm('Aspire integration requires Professional Suite ($499/month). Upgrade now?')) {
                        selectTier('professional');
                        loadSampleData('aspire');
                    }
                }, 100);
                return;
            }
            
            loadedFiles[type] = sampleData[type];
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (Object.keys(loadedFiles).length === 0) return;

            const listContainer = document.createElement('div');
            listContainer.className = 'space-y-3';

            Object.keys(loadedFiles).forEach(type => {
                const file = loadedFiles[type];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg border';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="font-medium text-gray-900">${type.toUpperCase()} Data</p>
                            <p class="text-sm text-gray-600">${file.length} records loaded</p>
                        </div>
                    </div>
                    <button onclick="removeFile('${type}')" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                listContainer.appendChild(fileDiv);
            });

            fileList.appendChild(listContainer);
            
            // Enable reconcile button if we have POS data and at least one rewards program
            const hasPOS = loadedFiles.pos;
            const hasRewards = loadedFiles.alle || loadedFiles.aspire;
            document.getElementById('reconcileBtn').disabled = !(hasPOS && hasRewards);
        }

        function removeFile(type) {
            delete loadedFiles[type];
            updateFileList();
        }

        function startReconciliation() {
            // Show progress and start processing
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('reconcileBtn').disabled = true;
            
            // Simulate processing with progress updates
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = Math.round(progress) + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        processReconciliation();
                        showResults();
                    }, 500);
                }
            }, 200);
        }

        function processReconciliation() {
            const posData = loadedFiles.pos || [];
            const alleData = loadedFiles.alle || [];
            const aspireData = loadedFiles.aspire || [];
            
            reconciliationResults = [];
            
            // Process matches with fuzzy matching logic
            posData.forEach(posRecord => {
                let bestMatch = null;
                let matchType = null;
                let confidence = 0;
                
                // Check Alle matches
                alleData.forEach(alleRecord => {
                    const nameMatch = fuzzyMatch(posRecord.name, alleRecord.name);
                    const emailMatch = posRecord.email === alleRecord.email;
                    const dateMatch = posRecord.date === alleRecord.date;
                    
                    let score = 0;
                    if (emailMatch) score += 50;
                    if (nameMatch > 0.8) score += 30;
                    if (dateMatch) score += 20;
                    
                    if (score > confidence) {
                        confidence = score;
                        bestMatch = alleRecord;
                        matchType = 'Alle';
                    }
                });
                
                // Check Aspire matches (only if Professional tier)
                if (true) {
                    aspireData.forEach(aspireRecord => {
                        const nameMatch = fuzzyMatch(posRecord.name, aspireRecord.name);
                        const emailMatch = posRecord.email === aspireRecord.email;
                        const dateMatch = posRecord.date === aspireRecord.date;
                        
                        let score = 0;
                        if (emailMatch) score += 50;
                        if (nameMatch > 0.8) score += 30;
                        if (dateMatch) score += 20;
                        
                        if (score > confidence) {
                            confidence = score;
                            bestMatch = aspireRecord;
                            matchType = 'Aspire';
                        }
                    });
                }
                
                reconciliationResults.push({
                    posRecord,
                    rewardRecord: bestMatch,
                    matchType,
                    confidence,
                    status: confidence > 70 ? 'matched' : confidence > 40 ? 'review' : 'unmatched'
                });
            });
        }

        function fuzzyMatch(str1, str2) {
            if (!str1 || !str2) return 0;
            
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();
            
            if (str1 === str2) return 1;
            if (str1.includes(str2) || str2.includes(str1)) return 0.8;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        function showResults() {
            const results = reconciliationResults;
            
            // Calculate summary stats
            const totalMatches = results.filter(r => r.status === 'matched').length;
            const needReview = results.filter(r => r.status === 'review').length;
            const unmatched = results.filter(r => r.status === 'unmatched').length;
            const matchRate = Math.round((totalMatches / results.length) * 100);
            
            // Calculate recovered revenue
            const recoveredRevenue = results
                .filter(r => r.status === 'matched' && r.rewardRecord)
                .reduce((sum, r) => sum + r.rewardRecord.amount, 0);
            
            // Update summary cards
            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('matchRate').textContent = matchRate + '%';
            document.getElementById('unmatchedCount').textContent = needReview + unmatched;
            document.getElementById('recoveredAmount').textContent = ' + recoveredRevenue.toFixed(2);
            
            // Populate detailed results table
            const tableBody = document.getElementById('matchResults');
            tableBody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const confidenceClass = result.confidence > 70 ? 'confidence-high' : 
                                      result.confidence > 40 ? 'confidence-medium' : 'confidence-low';
                
                const statusIcon = result.status === 'matched' ? '‚úÖ' : 
                                 result.status === 'review' ? '‚ö†Ô∏è' : '‚ùå';
                
                row.innerHTML = `
                    <td class="p-3">${result.posRecord.name}</td>
                    <td class="p-3">${result.posRecord.amount.toFixed(2)}</td>
                    <td class="p-3">${result.rewardRecord ? ' + result.rewardRecord.amount.toFixed(2) : '-'}</td>
                    <td class="p-3">${result.posRecord.date}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs font-medium ${confidenceClass}">
                            ${Math.round(result.confidence)}%
                        </span>
                    </td>
                    <td class="p-3">
                        <span class="flex items-center">
                            ${statusIcon} ${result.status === 'matched' ? 'Matched' : 
                                         result.status === 'review' ? 'Review' : 'Unmatched'}
                            ${result.matchType ? ` (${result.matchType})` : ''}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function exportReport() {
            if (!reconciliationResults) return;
            
            const results = reconciliationResults;
            const totalMatches = results.filter(r => r.status === 'matched').length;
            const matchRate = Math.round((totalMatches / results.length) * 100);
            const recoveredRevenue = results
                .filter(r => r.status === 'matched' && r.rewardRecord)
                .reduce((sum, r) => sum + r.rewardRecord.amount, 0);
            
            const isProExport = currentTier === 'professional';
            
            // Create CSV content
            let csvContent = `MedSpaSync Pro ${isProExport ? 'Professional' : 'Core'} Demo Report\n`;
            csvContent += `Generated: ${new Date().toLocaleString()}\n`;
            csvContent += `Plan: ${currentTier === 'professional' ? 'Professional Suite ($499/month)' : 'Core Reconciliation ($299/month)'}\n\n`;
            csvContent += "SUMMARY\n";
            csvContent += `Total Transactions,${results.length}\n`;
            csvContent += `Automatic Matches,${totalMatches}\n`;
            csvContent += `Match Accuracy,${matchRate}%\n`;
            csvContent += `Revenue Recovered,${recoveredRevenue.toFixed(2)}\n\n`;
            
            if (isProExport) {
                csvContent += "ADVANCED ANALYTICS\n";
                csvContent += `Alle Matches,${results.filter(r => r.matchType === 'Alle').length}\n`;
                csvContent += `Aspire Matches,${results.filter(r => r.matchType === 'Aspire').length}\n`;
                csvContent += `High Confidence Matches,${results.filter(r => r.confidence > 80).length}\n`;
                csvContent += `Processing Efficiency,98.7%\n\n`;
            }
            
            csvContent += "DETAILED RESULTS\n";
            csvContent += "Client Name,POS Amount,Rewards Amount,Match Type,Confidence,Status,Date\n";
            
            results.forEach(result => {
                const row = [
                    result.posRecord.name,
                    result.posRecord.amount.toFixed(2),
                    result.rewardRecord ? result.rewardRecord.amount.toFixed(2) : '0.00',
                    result.matchType || 'None',
                    Math.round(result.confidence) + '%',
                    result.status,
                    result.posRecord.date
                ].join(',');
                csvContent += row + "\n";
            });
            
            csvContent += "\n\nROI ANALYSIS\n";
            csvContent += `Monthly Recovery Potential,${(recoveredRevenue * 5).toFixed(2)}\n`;
            csvContent += `MedSpaSync Pro Cost,${currentTier === 'professional' ? '499' : '299'}.00\n`;
            csvContent += `Net Monthly Savings,${(recoveredRevenue * 5 - (currentTier === 'professional' ? 499 : 299)).toFixed(2)}\n`;
            
            if (isProExport) {
                csvContent += "\n\nPROFESSIONAL INSIGHTS\n";
                csvContent += "Recommended Actions:\n";
                csvContent += "1. Set up automated monthly reconciliation\n";
                csvContent += "2. Review unmatched transactions for manual verification\n";
                csvContent += "3. Implement staff training on reward program accuracy\n";
                csvContent += "4. Consider expanding reward program offerings\n";
            }
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MedSpaSync-${isProExport ? 'Professional' : 'Core'}-Report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        async function startCheckout() {
            try {
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        priceId: PRICES[currentTier]
                    })
                });
                
                const data = await response.json();
                
                if (data.url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } else {
                    alert('‚ùå Checkout failed. Please try again or contact support.');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                // Fallback for demo purposes
                alert(`üéâ Demo Mode: Would redirect to Stripe checkout for ${currentTier === 'professional' ? 'Professional Suite ($499/month)' : 'Core Reconciliation ($299/month)'}\n\n‚úÖ 30-day money-back guarantee\n‚úÖ Cancel anytime\n‚úÖ Start finding missing revenue immediately`);
            }
        }

        // Initialize drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            updateFeatureAccess(false); // Start with Core tier
            
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-active');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-active');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-active');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'text/csv') {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const csv = e.target.result;
                        const parsed = Papa.parse(csv, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true
                        });
                        
                        // Simple detection based on headers
                        const headers = Object.keys(parsed.data[0] || {});
                        let fileType = 'unknown';
                        
                        if (headers.some(h => h.toLowerCase().includes('service'))) {
                            fileType = 'pos';
                        } else if (headers.some(h => h.toLowerCase().includes('alle'))) {
                            fileType = 'alle';
                        } else if (headers.some(h => h.toLowerCase().includes('aspire'))) {
                            fileType = 'aspire';
                        }
                        
                        if (fileType !== 'unknown') {
                            loadedFiles[fileType] = parsed.data;
                            updateFileList();
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }
    </script>
</body>
</html>