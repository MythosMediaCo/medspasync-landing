/* Enhanced MedSpaSync Pro Demo with improved functionality */

(function() {

  'use strict';



  console.log('🏥 MedSpaSync Pro Demo - Enhanced Version');



  // Prevent multiple initialization

  if (window.MedSpaSyncDemo) {

    console.warn('Demo already initialized');

    return;

  }



  // Wait for DOM

  function ready(callback) {

    if (document.readyState === 'loading') {

      document.addEventListener('DOMContentLoaded', callback);

    } else {

      callback();

    }

  }



  // Safe element getter with error handling

  function $(id) {

    const element = document.getElementById(id);

    if (!element) {

      console.warn(`Element #${id} not found`);

    }

    return element;

  }



  // Enhanced demo state

  const state = {

    files: { pos: null, alle: null, aspire: null },

    processing: false,

    results: null,

    currentStage: 0

  };



  // Enhanced sample data with more realistic content

  const sampleData = {

    pos: `name,service,amount,date,provider

"Sarah Johnson","Botox Cosmetic",450.00,"2024-03-15","Dr. Smith"

"Michael Chen","Juvederm Ultra",650.00,"2024-03-15","Dr. Johnson"

"Jennifer Smith","Dysport",380.00,"2024-03-16","Dr. Smith"

"Robert Davis","Restylane Lyft",700.00,"2024-03-16","Dr. Johnson"

"Lisa Anderson","Botox Cosmetic",525.00,"2024-03-17","Dr. Smith"

"David Williams","CoolSculpting Elite",1200.00,"2024-03-17","Tech Sarah"

"Emma Thompson","Juvéderm Voluma XC",800.00,"2024-03-18","Dr. Johnson"

"James Wilson","Laser Hair Removal",350.00,"2024-03-18","Tech Mike"`,



    alle: `customer_name,product,points_redeemed,redemption_date,transaction_id

"Sarah M Johnson","Botox Cosmetic",90,"2024-03-15","ALL001"

"Michael C Chen","Juvederm Ultra",130,"2024-03-15","ALL002"

"Jenny Smith","Dysport",76,"2024-03-16","ALL003"

"Lisa A Anderson","Botox Cosmetic",105,"2024-03-17","ALL004"

"Emma Thompson","Juvéderm Voluma XC",160,"2024-03-18","ALL005"`,



    aspire: `member_name,treatment,reward_amount,transaction_date,account_id

"Robert J Davis","Restylane Lyft",140.00,"2024-03-16","ASP001"

"David R Williams","Radiesse",96.00,"2024-03-19","ASP002"

"Emma J Thompson","Belotero Balance",84.00,"2024-03-20","ASP003"

"James W Wilson","GentleYAG Laser",70.00,"2024-03-20","ASP004"`

  };



  // Show notification

  function notify(message, type = 'success') {

    let container = $('notificationContainer');

    if (!container) {

      container = document.createElement('div');

      container.id = 'notificationContainer';

      document.body.appendChild(container);

    }



    const notification = document.createElement('div');

    notification.className = `notification ${type}`;

    notification.textContent = message;

    container.appendChild(notification);



    setTimeout(() => notification.classList.add('show'), 100);

    setTimeout(() => {

      notification.classList.remove('show');

      setTimeout(() => {

        if (notification.parentNode) {

          notification.parentNode.removeChild(notification);

        }

      }, 300);

    }, 3000);



    console.log(`${type.toUpperCase()}: ${message}`);

  }



  // Update file status

  function updateFileStatus(type, fileName, selected) {

    const statusEl = $(`${type}StatusDisplay`);

    const areaEl = $(`${type}UploadArea`);



    if (statusEl) {

      statusEl.textContent = selected ? `✓ ${fileName}` : 'Click to select CSV/TXT file';

      statusEl.style.color = selected ? 'var(--accent-green)' : 'var(--neutral-500)';

    }



    if (areaEl) {

      areaEl.classList.toggle('selected', selected);

    }

  }



  // Update button state

  function updateButton() {

    const btn = $('startReconciliationBtn');

    if (!btn) return;



    const fileCount = Object.values(state.files).filter(f => f).length;

    const allSelected = fileCount === 3;



    btn.disabled = !allSelected;

    btn.textContent = allSelected

      ? `🚀 Begin AI Reconciliation Process`

      : `Select ${3 - fileCount} more file${3 - fileCount !== 1 ? 's' : ''} to continue`;

  }



  // Load sample data

  function loadSample(type) {

    if (!sampleData[type]) return;



    const mockFile = {

      name: `sample_${type}_data.csv`,

      size: sampleData[type].length,

      content: sampleData[type]

    };



    state.files[type] = mockFile;

    updateFileStatus(type, mockFile.name, true);

    updateButton();

    notify(`Sample ${type.toUpperCase()} data loaded`);

  }



  // Handle file upload with enhanced drag and drop

  function handleFile(type, file) {

    if (!file) return;



    const validExts = ['.csv', '.txt'];

    const ext = '.' + file.name.split('.').pop().toLowerCase();



    if (!validExts.includes(ext)) {

      notify('Invalid file type. Please select CSV or TXT files.', 'error');

      return;

    }



    if (file.size > 10 * 1024 * 1024) {

      notify('File too large. Maximum size is 10MB.', 'error');

      return;

    }



    state.files[type] = file;

    updateFileStatus(type, file.name, true);

    updateButton();

    notify(`${type.toUpperCase()} file uploaded successfully`);

  }



  // Show section with enhanced visual feedback

  function showSection(sectionId) {

    const sections = ['uploadSection', 'processingSection', 'resultsSection'];

    sections.forEach(id => {

      const el = $(id);

      if (el) {

        el.classList.toggle('hidden', id !== sectionId);

      }

    });

    state.currentStage = sections.indexOf(sectionId);

    updateProgressBar(0);

  }



  // Update progress bar

  function updateProgressBar(progress) {

    const fill = $('progressFill');

    if (fill) {

      fill.style.width = `${progress}%`;

    }

    const stages = ['stage1', 'stage2', 'stage3', 'stage4'];

    stages.forEach((id, index) => {

      const el = $(id);

      if (el) {

        el.classList.remove('active', 'completed');

        if (index < state.currentStage) {

          el.classList.add('completed');

        } else if (index === state.currentStage) {

          el.classList.add('active');

        }

      }

    });

  }



  // Animate counter with improved easing

  function animateCounter(elementId, target, suffix = '') {

    const el = $(elementId);

    if (!el) return;



    const duration = 1500;

    const start = performance.now();



    function update() {

      const elapsed = performance.now() - start;

      const progress = Math.min(elapsed / duration, 1);

      const easedProgress = (t) => t * t * t * (t * (6 * t - 15) + 10); // Easing function

      const current = Math.floor(target * easedProgress(progress));



      el.textContent = current.toLocaleString() + suffix;



      if (progress < 1) {

        requestAnimationFrame(update);

      }

    }



    requestAnimationFrame(update);

  }



  // Display results in an enhanced table

  function displayResults(results) {

    showSection('resultsSection');



    const subtitle = $('resultsSubtitle');

    if (subtitle) {

      subtitle.innerHTML = `

        Processed ${results.total} transactions in ${results.processingTime}s<br>

        <span style="color: var(--accent-green); font-weight: 600;">Achieved ${results.accuracy}% accuracy</span>

      `;

    }



    animateCounter('totalTransactions', results.total);

    animateCounter('exactMatches', results.exact);

    animateCounter('fuzzyMatches', results.fuzzy);

    animateCounter('accuracy', results.accuracy, '%');



    const tbody = $('resultsTableBody');

    if (tbody && results.matches) {

      tbody.innerHTML = results.matches.map(match => `

        <tr>

          <td style="font-weight: 500;">${match.name}</td>

          <td>${match.service}</td>

          <td>${match.date}</td>

          <td style="text-align: right; font-weight: 500;">$${match.amount.toFixed(2)}</td>

          <td>

            <span class="badge-match badge-${match.type}">

              ${match.type.charAt(0).toUpperCase() + match.type.slice(1)}

            </span>

          </td>

          <td>

            <span class="badge-match ${match.confidence >= 90 ? 'badge-exact' : (match.confidence >= 70 ? 'badge-fuzzy' : '')}">

              ${match.confidence}%

            </span>

          </td>

        </tr>

      `).join('');

    }



    notify('Reconciliation completed successfully!');

  }



  // Simulate advanced reconciliation process with progress updates

  async function startReconciliation() {

    if (state.processing) {

      notify('Already processing...', 'error');

      return;

    }



    const files = state.files;

    if (!files.pos || !files.alle || !files.aspire) {

      notify('Please select all three files first', 'error');

      return;

    }



    state.processing = true;

    showSection('processingSection');

    state.currentStage = 1;

    updateProgressBar(20);



    await new Promise(resolve => setTimeout(resolve, 1500));

    state.currentStage = 2;

    updateProgressBar(50);



    await new Promise(resolve => setTimeout(resolve, 2000));

    state.currentStage = 3;

    updateProgressBar(80);



    await new Promise(resolve => setTimeout(resolve, 1000));

    state.currentStage = 4;

    updateProgressBar(100);



    try {

      const total = 10;

      const exact = 7;

      const fuzzy = 2;

      const accuracy = Math.round(((exact + fuzzy) / total) * 100);



      const results = {

        total,

        exact,

        fuzzy,

        accuracy,

        processingTime: 4.5,

        matches: [

          { name: "Sarah Johnson", service: "Botox Cosmetic", date: "2024-03-15", amount: 450.00, type: "exact", confidence: 98 },

          { name: "Michael Chen", service: "Juvederm Ultra", date: "2024-03-15", amount: 650.00, type: "exact", confidence: 99 },

          { name: "Jennifer Smith", service: "Dysport", date: "2024-03-16", amount: 380.00, type: "fuzzy", confidence: 87 },

          { name: "Robert Davis", service: "Restylane Lyft", date: "2024-03-16", amount: 700.00, type: "exact", confidence: 96 },

          { name: "Lisa Anderson", service: "Botox Cosmetic", date: "2024-03-17", amount: 525.00, type: "exact", confidence: 97 },

          { name: "David Williams", service: "CoolSculpting Elite", date: "2024-03-17", amount: 1200.00, type: "fuzzy", confidence: 82 },

          { name: "Emma Thompson", service: "Juvéderm Voluma XC", date: "2024-03-18", amount: 800.00, type: "exact", confidence: 95 }

        ]

      };

      state.results = results;

      displayResults(results);



    } catch (error) {

      console.error('Processing error:', error);

      notify('Processing failed. Please try again.', 'error');

      showSection('uploadSection');

    } finally {

      state.processing = false;

    }

  }



  // Export results to CSV with more detailed content

  function exportResults() {

    if (!state.results) {

      notify('No results to export', 'error');

      return;

    }



    const csvRows = [

      ['MedSpaSync Pro Reconciliation Report'],

      [`Generated: ${new Date().toISOString()}`],

      [`Total Transactions: ${state.results.total}`],

      [`Accuracy: ${state.results.accuracy}%`],

      [''],

      ['Customer Name', 'Service', 'Date', 'Amount', 'Match Type', 'Confidence']

    ];



    state.results.matches.forEach(match => {

      csvRows.push([match.name, match.service, match.date, match.amount.toFixed(2), match.type, `${match.confidence}%`]);

    });



    const csvContent = csvRows.map(row => row.join(',')).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');

    link.href = url;

    link.download = 'medspasync_reconciliation_report.csv';

    document.body.appendChild(link);

    link.click();

    document.body.removeChild(link);

    URL.revokeObjectURL(url);

    notify('Report exported to CSV!');

  }



  ready(() => {

    console.log('Demo is ready!');

    window.MedSpaSyncDemo = true;



    const posUpload = $('posFileInput');

    const alleUpload = $('alleFileInput');

    const aspireUpload = $('aspireFileInput');

    const loadPosSample = $('loadPosSampleBtn');

    const loadAlleSample = $('loadAlleSampleBtn');

    const loadAspireSample = $('loadAspireSampleBtn');

    const startBtn = $('startReconciliationBtn');

    const exportBtn = $('exportReportBtn');

    const posArea = $('posUploadArea');

    const alleArea = $('alleUploadArea');

    const aspireArea = $('aspireUploadArea');



    if (posUpload) posUpload.addEventListener('change', (e) => handleFile('pos', e.target.files[0]));

    if (alleUpload) alleUpload.addEventListener('change', (e) => handleFile('alle', e.target.files[0]));

    if (aspireUpload) aspireUpload.addEventListener('change', (e) => handleFile('aspire', e.target.files[0]));

    if (loadPosSample) loadPosSample.addEventListener('click', () => loadSample('pos'));

    if (loadAlleSample) loadAlleSample.addEventListener('click', () => loadSample('alle'));

    if (loadAspireSample) loadAspireSample.addEventListener('click', () => loadSample('aspire'));

    if (startBtn) startBtn.addEventListener('click', startReconciliation);

    if (exportBtn) exportBtn.addEventListener('click', exportResults);



    // Enhanced drag and drop functionality

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {

      posArea?.addEventListener(eventName, (e) => {

        e.preventDefault();

        if (eventName === 'dragover') posArea.classList.add('dragover');

        if (eventName === 'dragleave' || eventName === 'drop') posArea.classList.remove('dragover');

      });

      alleArea?.addEventListener(eventName, (e) => {

        e.preventDefault();

        if (eventName === 'dragover') alleArea.classList.add('dragover');

        if (eventName === 'dragleave' || eventName === 'drop') alleArea.classList.remove('dragover');

      });

      aspireArea?.addEventListener(eventName, (e) => {

        e.preventDefault();

        if (eventName === 'dragover') aspireArea.classList.add('dragover');

        if (eventName === 'dragleave' || eventName === 'drop') aspireArea.classList.remove('dragover');

      });

    });



    if (posArea) posArea.addEventListener('drop', (e) => handleFile('pos', e.dataTransfer.files[0]));

    if (alleArea) alleArea.addEventListener('drop', (e) => handleFile('alle', e.dataTransfer.files[0]));

    if (aspireArea) aspireArea.addEventListener('drop', (e) => handleFile('aspire', e.dataTransfer.files[0]));



    updateButton();

  });

})();